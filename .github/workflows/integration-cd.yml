name: Integration CD for QAnightly

on:
  push:
    branches:
      - ops/ci-cd-rework

env:
  GCLOUD_NAMESPACE: 'prestashop-cloud-integration'
  PROJECT_NAME: 'api-qanightlyresults'
  TF_VERSION: '1.3.7'
  APP_PATH: ./
  APP_CLOUD_PATH: "./terraform/envs/integration"

jobs:
  integration_deployment:
    name: Deploy (integration)
    runs-on: ubuntu-latest
    concurrency: integration-cd

    steps:
      - name: Setting up Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Reconfig git to download terraform modules from private repos
        run: |
          git config --global url."https://oauth2:${{ secrets.TERRAFORM_ACCESS_TOKEN }}@github.com".insteadOf ssh://git@github.com

      - name: Auth GCP
        uses: ./.github/actions/auth-gcp
        with:
          gcp-credentials: ${{ secrets.INTEGRATION_GOOGLE_APPLICATION_CREDENTIALS }}
          cluster-name: "test-cluster-1"

      - name: Build API app ðŸ‘·
        uses: ./.github/actions/build
        with:
          project: ${{ env.PROJECT_NAME }}
          gcp-credentials: ${{ secrets.INTEGRATION_GOOGLE_APPLICATION_CREDENTIALS }}
          gcp-namespace: ${{ env.GCLOUD_NAMESPACE }}
          app-path: ${{ env.APP_PATH }}

      - name: Deploy app ðŸšš
        uses: ./.github/actions/deploy
        with:
          workspace: default
          cloud-path: ${{ env.APP_CLOUD_PATH }}
          gcp-credentials: ${{ secrets.INTEGRATION_GOOGLE_APPLICATION_CREDENTIALS }}
          gcp-namespace: ${{ env.GCLOUD_NAMESPACE }}
          environment: "integration"
